local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")

-- Store original lighting settings
local originalLighting = {
    Ambient = Lighting.Ambient,
    OutdoorAmbient = Lighting.OutdoorAmbient,
    Brightness = Lighting.Brightness,
    FogColor = Lighting.FogColor,
    FogStart = Lighting.FogStart,
    FogEnd = Lighting.FogEnd,
}

-- Function to reset the lighting to original settings
local function resetLighting()
    -- Remove existing sky
    for _, child in pairs(Lighting:GetChildren()) do
        if child:IsA("Sky") then
            child:Destroy()
        end
    end

    -- Restore original lighting effects
    Lighting.Ambient = originalLighting.Ambient
    Lighting.OutdoorAmbient = originalLighting.OutdoorAmbient
    Lighting.Brightness = originalLighting.Brightness
    Lighting.FogColor = originalLighting.FogColor
    Lighting.FogStart = originalLighting.FogStart
    Lighting.FogEnd = originalLighting.FogEnd
end

-- Function to create colorful firework effects that change color smoothly
local function createFireworks()
    local fireworkList = {}

    for i = 1, 10 do
        local firework = Instance.new("Part")
        firework.Size = Vector3.new(0.5, 0.5, 0.5)
        firework.Position = Vector3.new(math.random(-100, 100), math.random(40, 100), math.random(-100, 100))
        firework.Anchored = true
        firework.CanCollide = false
        firework.Name = "Firework"
        firework.Parent = workspace

        local particleEmitter = Instance.new("ParticleEmitter")
        particleEmitter.Color = ColorSequence.new(Color3.new(1, 0, 0), Color3.new(0, 1, 0), Color3.new(0, 0, 1), Color3.new(1, 0, 1))
        particleEmitter.Lifetime = NumberRange.new(1, 2)
        particleEmitter.Rate = 200
        particleEmitter.Speed = NumberRange.new(50, 100)
        particleEmitter.Size = NumberSequence.new(2, 4)
        particleEmitter.Parent = firework

        coroutine.wrap(function()
            while firework do
                local hue = tick() % 5 / 5
                local color = Color3.fromHSV(hue, 1, 1)
                particleEmitter.Color = ColorSequence.new(color, Color3.new(math.random(), math.random(), math.random()))
                wait(0.1)
            end
        end)()

        table.insert(fireworkList, firework)
    end

    -- Sync fireworks with the song
    local audioPlaying = true

    RunService.Heartbeat:Connect(function()
        if audioPlaying then
            for _, firework in ipairs(fireworkList) do
                local bobbingHeight = math.sin(tick() * 2) * 5
                firework.Position = firework.Position + Vector3.new(0, bobbingHeight, 0)
            end
        end
    end)

    return fireworkList
end

-- Function to create additional fireworks around sparklers
local function createAdditionalFireworks(parentPart)
    for i = 1, 3 do -- Multiple effects per sparkler
        local additionalFirework = Instance.new("Part")
        additionalFirework.Size = Vector3.new(0.5, 0.5, 0.5)
        additionalFirework.Position = parentPart.Position + Vector3.new(math.random(-5, 5), math.random(10, 15), math.random(-5, 5))
        additionalFirework.Anchored = true
        additionalFirework.CanCollide = false
        additionalFirework.Name = "AdditionalFirework"
        additionalFirework.Parent = workspace

        -- Burst effect
        local burstEmitter = Instance.new("ParticleEmitter")
        burstEmitter.Color = ColorSequence.new(Color3.new(1, 0, 0), Color3.new(0, 1, 0), Color3.new(0, 0, 1), Color3.new(1, 0.5, 0))
        burstEmitter.Lifetime = NumberRange.new(1, 1.5)
        burstEmitter.Rate = 500
        burstEmitter.Speed = NumberRange.new(40, 60)
        burstEmitter.Size = NumberSequence.new(1.5, 2)
        burstEmitter.Parent = additionalFirework

        -- Randomized color bursts
        coroutine.wrap(function()
            while additionalFirework do
                burstEmitter.Color = ColorSequence.new(Color3.fromHSV(math.random(), 1, 1))
                wait(0.5)
            end
        end)()
    end
end

-- Function to create dynamic thunder and lighting effects
local function createThunderEffect()
    while true do
        wait(math.random(2, 5))  -- Wait between strikes
        Lighting.Brightness = 10  -- Increase brightness to simulate lightning
        wait(0.1)                 -- Short flicker
        Lighting.Brightness = 2   -- Return to normal
    end
end

-- Function to create rainbow rain effect
local function createRainbowRain()
    local rain = Instance.new("Part")
    rain.Size = Vector3.new(0.1, 0.1, 0.1) -- Size of droplets
    rain.Position = Vector3.new(0, 100, 0)  -- Positioning the rain above the map
    rain.Anchored = true
    rain.CanCollide = false
    rain.Parent = workspace

    local rainEmitter = Instance.new("ParticleEmitter")
    rainEmitter.Color = ColorSequence.new(
        Color3.fromRGB(255, 0, 0),
        Color3.fromRGB(255, 127, 0),
        Color3.fromRGB(255, 255, 0),
        Color3.fromRGB(0, 255, 0),
        Color3.fromRGB(0, 0, 255),
        Color3.fromRGB(75, 0, 130),
        Color3.fromRGB(148, 0, 211)
    )
    rainEmitter.Lifetime = NumberRange.new(0.5, 1)
    rainEmitter.Rate = 1000
    rainEmitter.Speed = NumberRange.new(10, 20)
    rainEmitter.Size = NumberSequence.new(0.1, 0.3)
    rainEmitter.VelocityInheritance = 0.5
    rainEmitter.Parent = rain

    -- Control the position to create a falling effect
    coroutine.wrap(function()
        while true do
            rain.Position = rain.Position - Vector3.new(0, 1, 0) -- Move downward
            wait(0.1)
        end
    end)()
end

-- Lighting Effects for Theme
Lighting.Ambient = Color3.fromRGB(255, 140, 0)
Lighting.OutdoorAmbient = Color3.fromRGB(10, 10, 10)
Lighting.Brightness = 2
Lighting.FogColor = Color3.fromRGB(255, 100, 0)
Lighting.FogStart = 200
Lighting.FogEnd = 800
local sky = Instance.new("Sky")
sky.SkyboxBk = "rbxassetid://159454299"
sky.SkyboxDn = "rbxassetid://159454299"
sky.SkyboxFt = "rbxassetid://159454299"
sky.SkyboxLf = "rbxassetid://159454299"
sky.SkyboxRt = "rbxassetid://159454299"
sky.SkyboxUp = "rbxassetid://159454299"
sky.Parent = Lighting

-- Sound Setup
local audioId = "rbxassetid://16190782786"
local sound = Instance.new("Sound")
sound.SoundId = audioId
sound.Looped = false
sound.Volume = 1
sound.Parent = workspace
sound:Play()

-- Create fireworks and sparklers
local fireworkList = createFireworks()
createSparklers(fireworkList)

-- Start thunder effects
coroutine.wrap(createThunderEffect)()

-- Create rainbow rain effect
createRainbowRain()

-- Wait for the song to finish and then reset everything
sound.Ended:Wait()  -- Wait until the sound ends

-- Remove all fireworks and rain
for _, item in ipairs(workspace:GetChildren()) do
    if item:IsA("Part") and (item.Name == "Firework" or item.Name == "AdditionalFirework" or item.Name == "Sparkler") then
        item:Destroy()
    elseif item.Name == "rain" then
        item:Destroy()
    end
end

-- Reset lighting and remove all lighting effects
resetLighting()
